#include "HH.h"

uint8_t HHDecayTime[noOfHHs] = {defaultHHCloseDecay, defaultHHOpenDecay};
uint32_t HHAmpInc[noOfHHs];
uint32_t HHAmpValue[noOfHHs];
uint32_t HHAmpPos[noOfHHs];
uint32_t HHAmpLen[noOfHHs];
uint8_t HHNoteOn[noOfHHs] = {0, 0};
uint16_t HHLutPos[noOfHHs] = {0, 0};

const int8_t HHLUT[HHLUTSize] = { 
-29,
-45,
-6,
10,
3,
3,
7,
4,
20,
20,
-25,
-52,
-10,
41,
43,
12,
-32,
-51,
-21,
33,
29,
-12,
-7,
28,
7,
-38,
-31,
2,
24,
36,
35,
-26,
-68,
-39,
30,
54,
6,
9,
26,
-48,
-77,
7,
57,
28,
0,
0,
-29,
-37,
11,
31,
18,
2,
-10,
-38,
-21,
20,
35,
49,
-13,
-83,
-45,
25,
53,
46,
-5,
-52,
-34,
9,
33,
15,
-11,
-17,
-2,
8,
-12,
-12,
17,
44,
20,
-55,
-67,
4,
52,
61,
12,
-71,
-67,
17,
55,
14,
3,
6,
-29,
-32,
2,
28,
23,
12,
-14,
-38,
-26,
14,
46,
15,
-35,
-29,
7,
20,
34,
12,
-44,
-57,
-13,
47,
36,
1,
30,
-3,
-79,
-52,
39,
60,
16,
16,
-25,
-67,
-29,
36,
45,
36,
4,
-64,
-48,
5,
34,
35,
39,
-19,
-79,
-34,
32,
62,
41,
-28,
-79,
-35,
39,
47,
14,
4,
-15,
-41,
-16,
24,
24,
29,
11,
-48,
-65,
-4,
43,
52,
33,
-44,
-61,
-25,
28,
44,
14,
1,
-15,
-35,
-14,
24,
22,
2,
-3,
20,
-6,
-52,
-30,
27,
46,
38,
-30,
-73,
-9,
29,
19,
6,
10,
16,
-5,
-53,
-16,
57,
20,
-39,
-39,
6,
33,
17,
-7,
-13,
-6,
25,
13,
-19,
-22,
-9,
1,
0,
39,
11,
-49,
-37,
13,
45,
30,
-25,
-45,
6,
21,
24,
3,
-28,
-24,
-2,
17,
18,
0,
-17,
-8,
9,
6,
-6,
2,
-3,
-7,
-6,
-12,
11,
24,
4,
-4,
-2,
-2,
-16,
-11,
5,
34,
26,
-40,
-57,
-15,
34,
32,
19,
26,
-24,
-70,
-22,
35,
40,
15,
20,
-3,
-75,
-53,
33,
83,
31,
-70,
-64,
25,
65,
41,
-18,
-72,
-46,
22,
58,
35,
-26,
-49,
-24,
27,
34,
6,
22,
1,
-56,
-49,
9,
41,
22,
16,
31,
-39,
-79,
-13,
49,
37,
12,
13,
-37,
-59,
-2,
40,
50,
22,
-48,
-53,
-16,
16,
41,
53,
-5,
-68,
-47,
11,
48,
39,
24,
-50,
-70,
-1,
42,
33,
-8,
-8,
7,
-20,
-12,
9,
13,
11,
2,
-15,
-25,
-6,
34,
80,
-32,
-128,
-38,
74,
72,
-5,
-34,
-21,
8,
17,
9,
0,
-16,
-16,
9,
11,
7,
1,
-10,
-9,
-8,
10,
4,
-12,
-9,
17,
48,
-18,
-68,
-22,
33,
36,
16,
3,
-39,
-23,
0,
0,
19,
19,
-5,
-14,
-1,
29,
48,
-25,
-96,
-39,
46,
69,
41,
-42,
-72,
-18,
34,
32,
3,
-4,
-5,
-4,
-2,
1,
0,
7,
10,
-15,
-22,
5,
9,
6,
17,
-1,
-38,
-18,
22,
22,
-6,
12,
45,
-26,
-80,
-44,
37,
64,
11,
-5,
-13,
-30,
-8,
41,
33,
-42,
-55,
-10,
39,
41,
10,
8,
-33,
-55,
-5,
41,
51,
-1,
-59,
-43,
15,
43,
43,
9,
-55,
-58,
8,
42,
47,
37,
-61,
-89,
1,
53,
34,
9,
12,
-31,
-47,
-8,
27,
27,
8,
29,
3,
-78,
-58,
38,
58,
24,
12,
-41,
-69,
-1,
47,
62,
9,
-62,
-61,
7,
48,
19,
30,
10,
-64,
-62,
14,
50,
38,
30,
-40,
-83,
-9,
45,
37,
7,
2,
-19,
-37,
-9,
27,
20,
4,
50,
-16,
-101,
-46,
40,
69,
25,
4,
-23,
-56,
-24,
33,
47,
40,
-12,
-86,
-52,
41,
57,
31,
-3,
-53,
-34,
2,
31,
43,
-3,
-49,
-32,
11,
23,
26,
14,
9,
-29,
-50,
-6,
57,
47,
-38,
-64,
-18,
32,
38,
7,
-13,
3,
-6,
-23,
-5,
24,
13,
-17,
-11,
-6,
18,
44,
2,
-68,
-50,
21,
38,
14,
14,
18,
-21,
-46,
-19,
14,
20,
10,
7,
17,
1,
-37,
-30,
13,
24,
43,
32,
-69,
-87,
-1,
68,
39,
10,
18,
-52,
-69,
-1,
57,
41,
-9,
-32,
-19,
12,
12,
9,
8,
-9,
-30,
-3,
38,
2,
-46,
-29,
22,
55,
32,
-31,
-63,
-19,
27,
34,
-2,
8,
34,
-31,
-53,
-14,
24,
27,
-8,
-17,
1,
9,
14,
5,
-6,
-8,
-5,
-9,
14,
46,
-14,
-73,
-40,
33,
52,
29,
6,
-39,
-43,
-6,
14,
21,
16,
35,
7,
-68,
-54,
14,
48,
26,
-8,
-9,
-4,
-16,
-1,
15,
40,
23,
-71,
-66,
7,
39,
28,
31,
24,
-50,
-58,
-7,
30,
34,
22,
4,
-38,
-43,
-4,
41,
34,
-3,
-37,
-21,
1,
24,
24,
-15,
-15,
-2,
2,
-6,
27,
13,
-36,
-35,
-3,
34,
27,
-4,
-9,
-13,
-12,
6,
15,
11,
-11,
-9,
-7,
3,
3,
1,
7,
7,
2,
-11,
-28,
-12,
18,
19,
50,
-6,
-91,
-41,
41,
88,
32,
-76,
-72,
2,
47,
37,
22,
-25,
-58,
-12,
39,
63,
-4,
-69,
-36,
4,
31,
23,
16,
26,
-34,
-63,
-9,
42,
29,
7,
-3,
-33,
-20,
13,
23,
47,
5,
-70,
-53,
3,
47,
20,
-4,
-3,
-2,
20,
-4,
-33,
-19,
25,
57,
-9,
-67,
-33,
26,
41,
11,
-21,
-38,
7,
32,
39,
5,
-52,
-50,
2,
40,
26,
15,
-23,
-32,
-6,
43,
37,
-34,
-55,
-27,
22,
41,
18,
5,
-1,
-29,
-37,
3,
32,
33,
3,
-37,
-31,
-6,
11,
30,
39,
-3,
-53,
-50,
16,
43,
39,
29,
-49,
-70,
-10,
43,
29,
19,
21,
-49,
-63,
2,
38,
31,
-1,
1,
-11,
-29,
1,
21,
11,
9,
4,
-29,
-27,
3,
58,
48,
-76,
-95,
11,
68,
37,
-8,
23,
-4,
-81,
-34,
48,
40,
0,
-14,
-11,
11,
13,
-10,
-19,
1,
14,
10,
-19,
-30,
3,
71,
34,
-81,
-73,
6,
64,
24,
-12,
-6,
2,
-2,
-11,
-5,
6,
15,
-2,
-1,
-15,
-21,
10,
32,
44,
-17,
-88,
-34,
45,
53,
2,
-43,
-24,
24,
25,
-1,
-2,
-2,
-12,
-10,
6,
14,
4,
-7,
-12,
-11,
3,
16,
19,
22,
-27,
-63,
-12,
38,
34,
-8,
38,
24,
-89,
-73,
25,
68,
23,
21,
-14,
-74,
-28,
33,
42,
8,
-5,
1,
-18,
-21,
0,
16,
11,
30,
19,
-63,
-65,
13,
62,
40,
-20,
-58,
-22,
28,
30,
19,
9,
-20,
-48,
-3,
32,
9,
-8,
-25,
0,
33,
2,
-20,
-9,
27,
14,
-42,
-17,
23,
15,
22,
15,
-37,
-52,
-4,
27,
27,
11,
-12,
-11,
-8,
-6,
3,
18,
7,
-14,
-8,
-6
};

void initHHParams(void)
{
	for (uint8_t i = 0; i < noOfHHs; i++)
		calcHHDecayTim(i);
}

void changeHHDecayTime(uint8_t instrument, uint8_t newTime)
{
	//Check range
	if (instrument < noOfHHs)
	{
		//Increase or decrease time
		switch (newTime)
		{
			//Decrease time
			case 0:
				if (HHDecayTime[instrument] > kickDecMin)
					HHDecayTime[instrument]--;
				break;
			//Increase time
			case 1:
				if (HHDecayTime[instrument] < kickDecMax)
					HHDecayTime[instrument]++;
				break;
			default:
				break;
		}
		
		calcHHDecayTim(instrument);
	}
}

void calcHHDecayTim(uint8_t instrument)
{
	double decayTime;

	if (instrument == 0)
		decayTime = (double)HHDecayTime[instrument] / 10 * ClosedHHMaxDecayTime;
	else
		decayTime = (double)HHDecayTime[instrument] / 10 * OpenHHMaxDecayTime;
	
	//Convert to increment value and scale for amp decay LUT
	double inc = ampDecLUTSize * decayTime / fs;
	
	HHAmpLen[instrument] = fs * decayTime;
	
	//Convert to fixed point increment value
	HHAmpInc[instrument] = inc * pow(2, fixedPointPos);
}

void setHHNoteOn(uint8_t instrument)
{
	//Check range
	if (instrument < noOfHHs)
	{
		HHAmpValue[instrument] = fp(255);
		HHNoteOn[instrument] = 1;
		HHAmpPos[instrument] = 0;
		
		//Cancel other HH
		HHNoteOn[!instrument] = 0;
	}
}

void incHHLUTPos(uint8_t instrument)
{
	//Check range
	if (instrument < noOfHHs)
	{
		HHLutPos[instrument]++;
		
		if (HHLutPos[instrument] >= HHLUTSize)
			HHLutPos[instrument] -= HHLUTSize;
	}
}

uint8_t getCurrentHHAmp(uint8_t instrument)
{
	//Check range
	if (instrument < noOfHHs)
	{
		HHAmpPos[instrument]++;
		
		//During note
		if (HHAmpPos[instrument] < HHAmpLen[instrument])
		{
			HHAmpValue[instrument] -= HHAmpInc[instrument];
			return ufp(HHAmpValue[instrument]);
		}
		//Note finished
		else
		{
			HHNoteOn[instrument] = 0;
			return 0;
		}
	}
	else
		return 0;
}

void HHGenerateBuffer(uint8_t instrument, int8_t *buffer, uint16_t nFrames)
{
	uint8_t amp;
	int32_t val;
	
	//Check range
	if ((instrument < noOfHHs) && (HHNoteOn[instrument]))
	{
		for (uint16_t i = 0; i < nFrames; i++)
		{
			amp = getCurrentHHAmp(instrument);
			
			val = amp * HHLUT[HHLutPos[instrument]];
			
			incHHLUTPos(instrument);
			
			buffer[i] = val / 256;
		}
	}
	else
		memset(buffer, 0, nFrames * sizeof(int8_t));
}
